name: Clone Detection

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  clone-detection:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diffs
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install NLCI CLI
        run: npm install -g @nlci/cli
      
      - name: Scan for clones
        id: scan
        run: |
          echo "Scanning for code clones..."
          nlci scan src/ --config .nlcirc.json
          
          echo "Generating reports..."
          nlci report --format json --output clones.json
          nlci report --format html --output clones-report.html
          
          echo "scan_complete=true" >> $GITHUB_OUTPUT
      
      - name: Parse results
        id: results
        run: |
          CLONE_COUNT=$(jq '.clonePairs | length' clones.json)
          TOTAL_FILES=$(jq '.filesIndexed' clones.json)
          CLONE_PERCENT=$(jq -r '.clonePairs | length as $clones | ($clones / '$TOTAL_FILES' * 100 | tostring)' clones.json)
          
          echo "clone_count=$CLONE_COUNT" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "clone_percent=$CLONE_PERCENT" >> $GITHUB_OUTPUT
          
          echo "Found $CLONE_COUNT clone pairs in $TOTAL_FILES files ($CLONE_PERCENT%)"
      
      - name: Check thresholds
        run: |
          MAX_CLONES=10
          MAX_PERCENT=5.0
          
          CLONE_COUNT=${{ steps.results.outputs.clone_count }}
          CLONE_PERCENT=${{ steps.results.outputs.clone_percent }}
          
          if [ "$CLONE_COUNT" -gt "$MAX_CLONES" ]; then
            echo "❌ Too many clone pairs: $CLONE_COUNT (max: $MAX_CLONES)"
            exit 1
          fi
          
          if (( $(echo "$CLONE_PERCENT > $MAX_PERCENT" | bc -l) )); then
            echo "❌ Clone percentage too high: $CLONE_PERCENT% (max: $MAX_PERCENT%)"
            exit 1
          fi
          
          echo "✅ Clone detection passed"
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: clone-detection-report
          path: |
            clones.json
            clones-report.html
          retention-days: 30
      
      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          script: |
            const fs = require('fs');
            
            let report;
            try {
              report = JSON.parse(fs.readFileSync('clones.json', 'utf8'));
            } catch (err) {
              console.error('Failed to read report:', err);
              return;
            }
            
            const cloneCount = report.clonePairs.length;
            const totalFiles = report.filesIndexed;
            const clonePercent = ((cloneCount / totalFiles) * 100).toFixed(1);
            
            const status = cloneCount > 10 ? '❌' : '✅';
            
            let cloneList = '';
            if (cloneCount > 0 && cloneCount <= 5) {
              cloneList = report.clonePairs.map((clone, i) => {
                const sim = (clone.similarity * 100).toFixed(1);
                return `${i + 1}. **${clone.cloneType}** (${sim}% similar)
   - Source: \`${clone.source.filePath}:${clone.source.startLine}-${clone.source.endLine}\`
   - Target: \`${clone.target.filePath}:${clone.target.startLine}-${clone.target.endLine}\``;
              }).join('\n\n');
            } else if (cloneCount > 5) {
              cloneList = `Too many clones to display inline. [View full report](../actions/runs/${context.runId})`;
            }
            
            const comment = `## ${status} Clone Detection Report
            
**Summary:**
- Clone Pairs: **${cloneCount}**
- Files Scanned: **${totalFiles}**
- Clone Percentage: **${clonePercent}%**

${cloneList}

---
<details>
<summary>Configuration</summary>

\`\`\`json
${JSON.stringify(report.config, null, 2)}
\`\`\`
</details>

[View full HTML report](../actions/runs/${context.runId})
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Clone Detection Report')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
      
      - name: Create check run
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('clones.json', 'utf8'));
            
            const cloneCount = report.clonePairs.length;
            const conclusion = cloneCount > 10 ? 'failure' : 'success';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Clone Detection',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `Found ${cloneCount} clone pairs`,
                summary: `Scanned ${report.filesIndexed} files and detected ${cloneCount} code clone pairs.`,
                text: `See the workflow run for detailed report.`
              }
            });
