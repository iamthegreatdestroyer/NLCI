#!/bin/bash
# Pre-push hook for NLCI
# Ensures full test suite passes before pushing

set -e

echo "ğŸš€ Running pre-push checks..."

# Get list of commits to be pushed
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE="${1:-origin}"

echo "ğŸ“¤ Pushing to: $REMOTE/$CURRENT_BRANCH"

# Skip hook for certain branches
if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "develop" ]]; then
  echo "ğŸ”’ Running full test suite before pushing to $CURRENT_BRANCH"

  # Run full test suite
  echo "ğŸ§ª Running all tests..."
  if ! pnpm test; then
    echo "âŒ Tests failed. Fix issues and try again."
    exit 1
  fi

  # Run coverage check
  echo "ğŸ“Š Checking coverage..."
  if ! pnpm test:coverage; then
    echo "âš ï¸  Coverage check failed, but allowing push"
  fi

  # Build check
  echo "ğŸ—ï¸  Building..."
  if ! pnpm build; then
    echo "âŒ Build failed. Fix issues and try again."
    exit 1
  fi
else
  echo "âš¡ Running quick checks on feature branch"
  pnpm lint && pnpm typecheck
fi

echo "âœ… All pre-push checks passed!"
exit 0
